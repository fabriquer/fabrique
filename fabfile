#
# Fabrique build description for Fabrique.
#


debug = args.debug ? true;
asserts = args.asserts ? true;
debug_and_asserts = debug and asserts;

colour_output = args.colour_output ? true;
verbose_tests = args.verbose_tests ? false;

# TODO: platform tests
platform = struct
{
	freebsd = false;
	netbsd = false;
	openbsd = false;
	bsd = freebsd or netbsd or openbsd;

	ios = false;
	mac = true;
	darwin = ios or mac;

	linux = false;
	posix = bsd or darwin or linux;

	windows = false;

	library_name = function(name:string): string
	{
		if darwin
			'lib' + name + '.dylib'

		else if posix
			'lib' + name + '.so'

		else
			name + '.dll'
	};
};

cxx = import('share/cxx.fab', colour_diagnostics = colour_output);
lex = import('share/lex.fab');
lit = import('share/llvm-lit.fab', show_failure_details = verbose_tests);

# TODO: find the right yacc once we have a working 'which' plugin
yacc = import('share/yacc.fab', yacc = file('/usr/local/bin/byacc'));



#
# C++ compilation flags:
#
cxxoptions = [ '-std=c++11' ];

dbgflags =
	if debug [ '-g' '-ggdb' '-O0' ] else [ '-O2' ]
	+ if asserts [ '' ] else [ '-D NDEBUG' ]
	;

defines =
	(if platform.freebsd [ '-D OS_FREEBSD' ] else [])
	+ (if platform.netbsd [ '-D OS_NETBSD' ] else [])
	+ (if platform.openbsd [ '-D OS_OPENBSD' ] else [])
	+ (if platform.bsd [ '-D OS_BSD' ] else [])

	+ (if platform.ios [ '-D OS_IOS' ] else [])
	+ (if platform.mac [ '-D OS_MAC' ] else [])
	+ (if platform.darwin [ '-D OS_DARWIN' ] else [])

	+ (if platform.linux [ '-D OS_LINUX' ] else [])
	+ (if platform.posix [ '-D OS_POSIX' ] else [])

	+ (if platform.windows [ '-D OS_WINDOWS' ] else [])
	;

includes = foreach dir <- [ srcroot buildroot ] '-I ' + dir;

# Treat vendor headers as system headers (disable warnings).
vendor = [ '-isystem ' + srcroot + '/vendor' ];

common_cxx_flags = cxxoptions + defines + dbgflags + includes + vendor;

warnings = [
	# Use lots and lots of warnings.
	'-Weverything'

	# We intentionally hide yyFlexLexer::yylex().
	'-Wno-overloaded-virtual'

	# We really really don't care about C++98 compatibility.
	'-Wno-c++98-compat' '-Wno-c++98-compat-pedantic'

	# We aren't attempting to preserve an ABI. At least not yet.
	'-Wno-padded'
];

cxx_flags = common_cxx_flags + warnings;
generated_cxx_flags =
	common_cxx_flags + [ '-Wno-deprecated-register' ]
	+ if debug [ '-D' 'YYDEBUG' ] else [];

# Global constructors are a necessary evil for registering plugins. For now.
plugin_cxx_flags = cxx_flags + [ '-Wno-global-constructors' ];



#
# TODO: allow 'for module in [ ast backends dag ]
# (or even better, foreach dir in [ 'AST' 'Backend' ... ]
#   {
#     module = import(dir + '/' + dir + '.fab');
#     module.sources
#   }
#
cxx_srcs =
	files(driver.cc)
	+ import('AST').sources
	+ import('Backend').sources
	+ import('DAG').sources
	+ import('Parsing').sources
	+ import('Plugin').sources
	+ import('Support').sources
	+ import('Types').sources
	;


parser_src = yacc.process(file('Parsing/fab.yy'), subdir, 'Parsing/fab.yacc');
lexer_src = lex.process(
	src = file('Parsing/fab.lxx'), gen = file('Parsing/fab.lex.cc'),
	flags = [ '-c++'], header_out = file('Parsing/fab.lex.h')
);

objects =
	cxx.compile([ lexer_src ], generated_cxx_flags, deps = [ parser_src ])
	+ cxx.compile([ parser_src ], generated_cxx_flags)
	+ cxx.compile(cxx_srcs, cxx_flags)
	+ cxx.compile(import('plugins').sources, plugin_cxx_flags)
	;

fab_executable = cxx.link_executable(objects, executable = file('fab'));

test = lit.run(file('test'), file('lit-test-results'), 'report.txt',
	dependencies = [ fab_executable ] + import('test/manifest.fab').all_files);
