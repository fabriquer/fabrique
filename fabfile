#
# Fabrique build description for Fabrique.
#

which = import('which');

debug = args.debug ? true;
asserts = args.asserts ? true;
debug_and_asserts = debug and asserts;

withtests = args.tests ? true;

compiler = args.compiler ? 'c++';

colour_output = args.colour_output ? true;
verbose_tests = args.verbose_tests ? false;

platform = import('share/platform.fab');

cc = import('share/c.fab',
	colour_diagnostics = colour_output,
	platform = platform);

cxx = import('share/cxx.fab',
	compiler = which.executable(compiler),
	colour_diagnostics = colour_output,
	platform = platform);

# TODO: let modules "pass through" values from other modules
shell =
	if platform.posix import('share/shell-posix.fab')
	else import('share/shell-unimplemented.fab')
	;


#
# C++ compilation flags:
#
cxxoptions = [ '-std=c++14' ];

dbgflags =
	if debug [ '-g' '-ggdb' '-O0' ] else [ '-O2' ]
	+ if asserts [ '' ] else [ '-D NDEBUG' ]
	;

defines =
	(if platform.posix [ '-D OS_POSIX' ] else [])
	+ (if platform.darwin [ '-D OS_DARWIN' ] else [])
	+ (if platform.windows [ '-D OS_WINDOWS' ] else [])
	;

includes = foreach dir <- [ srcroot buildroot ] '-I ' + dir;

# Treat vendor headers as system headers (disable warnings).
vendor_flags = [ '-isystem ' + srcroot + '/vendor' ];

common_cxx_flags = cxxoptions + defines + dbgflags + includes + vendor_flags;

warnings = [
	# Use lots and lots of warnings.
	'-Weverything'

	# We really really don't care about C++98 compatibility.
	'-Wno-c++98-compat' '-Wno-c++98-compat-pedantic'

	# We aren't attempting to preserve an ABI. At least not yet.
	'-Wno-padded'

	# We are OK with C99 variable-length arrays.
	'-Wno-vla' '-Wno-vla-extension'
];

cxx_flags = common_cxx_flags + warnings;
generated_cxx_flags =
	common_cxx_flags + [ '-Wno-deprecated-register' ]
	+ if debug [ '-D' 'YYDEBUG' ] else [];


#
# TODO: allow 'for module in [ ast backends dag ]
# (or even better, foreach dir in [ 'AST' 'Backend' ... ]
#   {
#     module = import(dir + '/' + dir + '.fab');
#     module.sources
#   }
#
cxx_srcs =
	files(driver.cc)
	+ import('AST').sources
	+ import('Backend').sources
	+ import('DAG').sources
	+ import('Parsing').sources
	+ import('Plugin').sources
	+ import('Support').sources
	+ import('Types').sources
	;


objects = cxx.compile(cxx_srcs, cxx_flags);

plugins = foreach lib <- import('base-plugins').libs
	shell.copy(lib, file('lib/fabrique') + '/' + lib.filename)
	;

fab = cxx.link_executable(objects, executable = file('fab', subdir = 'bin'));

everything = [ fab ] + plugins + import('tests/manifest.fab').all_files;

test = if withtests {
	lit = import('share/lit.fab', show_failure_details = verbose_tests,
	             lit = args.lit ? import('which').executable('lit'));

	fab_path = buildroot + '/bin/fab';

	[ lit.run(fab_path, file('tests'), file('junit.xml'), dependencies = everything) ]
} else {
	[]
};
