#
# RUN: fab --print-dag --format=make --output=%t %s
# RUN: FileCheck %s -input-file %t/Makefile
#

cc = action('cc -c ${src} -o ${obj}' <- src:file[in], obj:file[out]);
link = action('cc ${objects} -o ${bin}' <- objects:list[file[in]], bin:file[out]);
lex = action('${LEX} -c++ --yyclass=${classname} --outfile=${gen} ${src}'
              <- src:file[in], gen:file[out], classname:string);

cc_all = function(srcs:list[string]): list[file]
{
	foreach src <- srcs
	{
		obj = file(src + '.o');
		build = cc(file(src), obj);
		obj
	}
};

srcs = [ 'foo.c' 'bar.c' 'baz.c' ];
gen = lex(file('foo.yy'), file('foo.c'), classname = 'FooClass');
objs = cc_all(srcs);
bin = link(objs, file('foo'));


# CHECK: srcs= foo.c bar.c baz.c
#
# CHECK-DAG: bin : ${buildroot}/foo
# CHECK-DAG: gen : ${buildroot}/foo.c
# CHECK-DAG: objs : ${buildroot}/foo.c.o ${buildroot}/bar.c.o ${buildroot}/baz.c.o
#
# CHECK-DAG: ${buildroot}/foo.c : ${srcroot}/foo.yy
# CHECK-NEXT-TODO:  ${LEX} -c++ --yyclass=FooClass --outfile=foo.c foo.yy
#
# CHECK-DAG: ${buildroot}/foo.c.o : ${srcroot}/foo.c
# CHECK-NEXT-TODO:  cc -c ${srcroot}/bfoo.c -o ${buildroot}/foo.c.o
#
# CHECK-DAG: ${buildroot}/bar.c.o : ${srcroot}/bar.c
# CHECK-NEXT-TODO:  cc -c ${srcroot}/bbar.c -o ${buildroot}/bar.c.o
#
# CHECK-DAG: ${buildroot}/baz.c.o : ${srcroot}/baz.c
# CHECK-NEXT-TODO:  cc -c ${srcroot}/bbaz.c -o ${buildroot}/baz.c.o
#
# CHECK-DAG: ${buildroot}/foo : ${buildroot}/foo.c.o ${buildroot}/bar.c.o ${buildroot}/baz.c.o
# CHECK-NEXT-TODO:  cc ${buildroot}/foo.c.o ${buildroot}/bar.c.o ${buildroot}/baz.c.o -o ${buildroot}/foo
